# BullAnalytics - Documentaci√≥n T√©cnica y Arquitectura

## üèóÔ∏è Arquitectura del Proyecto

### Stack Tecnol√≥gico

**Backend:**
- **FastAPI** (Python): Framework web as√≠ncrono para la API REST
- **yfinance**: Biblioteca para obtener datos financieros de Yahoo Finance
- **Groq API**: Integraci√≥n con modelo LLM (Llama 3.1 8B) para agentes de IA
- **matplotlib/seaborn**: Generaci√≥n de gr√°ficos en el backend (im√°genes PNG)
- **cachetools**: Sistema de cach√© con TTL (2 minutos) para optimizar rendimiento
- **Pillow**: Procesamiento de im√°genes para gr√°ficos
- **asyncio**: Tareas en background para monitoreo de reglas

**Frontend:**
- **HTML5/CSS3**: Estructura y estilos
- **Tailwind CSS**: Framework de utilidades CSS (modo oscuro con `class`)
- **JavaScript Vanilla**: Sin frameworks, c√≥digo modular en archivos separados
- **Backend-Generated Images**: Gr√°ficos renderizados como PNG en servidor

**Almacenamiento:**
- **JSON Files**: Persistencia local para:
  - `rules.json`: Reglas de alertas configuradas
  - `watchlists.json`: Listas de seguimiento personalizadas
  - `alerts.json`: Historial de alertas generadas
- **localStorage**: Configuraciones de usuario (vistas de tablas, preferencias)

## üìÅ Estructura de Archivos

```
finance_portfolio/
‚îú‚îÄ‚îÄ app.py                    # Backend FastAPI - API principal + background tasks
‚îú‚îÄ‚îÄ requirements.txt          # Dependencias Python
‚îú‚îÄ‚îÄ rules.json               # Base de datos de reglas de alertas
‚îú‚îÄ‚îÄ watchlists.json          # Base de datos de watchlists personalizadas
‚îú‚îÄ‚îÄ alerts.json              # Historial de alertas generadas
‚îÇ
‚îú‚îÄ‚îÄ index.html               # Landing page
‚îú‚îÄ‚îÄ dashboard.html           # Dashboard principal de activos
‚îú‚îÄ‚îÄ news.html                # P√°gina de noticias financieras
‚îú‚îÄ‚îÄ rules.html               # Gesti√≥n de reglas de alertas
‚îú‚îÄ‚îÄ account.html             # Panel de cuenta/usuario + historial de alertas
‚îú‚îÄ‚îÄ pricing.html             # P√°gina de planes (integrada en index)
‚îÇ
‚îú‚îÄ‚îÄ js/
‚îÇ   ‚îú‚îÄ‚îÄ dashboard.js         # L√≥gica principal del dashboard
‚îÇ   ‚îú‚îÄ‚îÄ analisis.js          # Gr√°ficos y an√°lisis visual (backend images)
‚îÇ   ‚îú‚îÄ‚îÄ calendar.js          # Calendario de earnings events
‚îÇ   ‚îú‚îÄ‚îÄ table-config.js      # Configuraci√≥n de vistas de tablas
‚îÇ   ‚îú‚îÄ‚îÄ investment-chat.js   # Chat widget de inversiones (n8n)
‚îÇ   ‚îú‚îÄ‚îÄ rules.js             # Gesti√≥n de reglas
‚îÇ   ‚îú‚îÄ‚îÄ news.js              # Carga y renderizado de noticias
‚îÇ   ‚îú‚îÄ‚îÄ dark-mode.js         # Toggle de modo oscuro
‚îÇ   ‚îî‚îÄ‚îÄ main.js              # Scripts generales
‚îÇ
‚îú‚îÄ‚îÄ css/
‚îÇ   ‚îú‚îÄ‚îÄ style.css            # Estilos globales
‚îÇ   ‚îú‚îÄ‚îÄ dashboard.css        # Estilos espec√≠ficos del dashboard
‚îÇ   ‚îú‚îÄ‚îÄ news.css             # Estilos de noticias
‚îÇ   ‚îú‚îÄ‚îÄ rules.css            # Estilos de reglas
‚îÇ   ‚îî‚îÄ‚îÄ pricing.css          # Estilos de pricing
‚îÇ
‚îú‚îÄ‚îÄ images/
‚îÇ   ‚îî‚îÄ‚îÄ logo.png             # Logo de BullAnalytics
‚îÇ
‚îî‚îÄ‚îÄ assets/
    ‚îî‚îÄ‚îÄ mockup.jpg           # Assets de dise√±o
```

## üîå API Endpoints (FastAPI)

### Assets y Datos Financieros
- `GET /api/tracking-assets` - Activos de seguimiento popular
- `GET /api/portfolio-assets` - Activos del portafolio personal
- `GET /api/crypto-assets` - Criptomonedas
- `GET /api/argentina-assets` - Acciones argentinas
- `GET /api/asset/{ticker}` - Datos de un activo espec√≠fico
- `GET /api/asset/{ticker}/history` - Historial de precios (par√°metros: period, interval)
- `GET /api/search-assets` - B√∫squeda de activos (query parameter)

### Watchlists Personalizadas
- `GET /api/watchlists` - Lista todas las watchlists
- `GET /api/watchlist/{name}` - Obtiene activos de una watchlist
- `POST /api/watchlist` - Crea nueva watchlist (body: name, assets[])
- `DELETE /api/watchlist/{name}` - Elimina una watchlist

### Gr√°ficos (Retornan im√°genes PNG)
- `GET /api/chart/treemap` - Treemap (par√°metros: category, metric)
- `GET /api/chart/bar` - Gr√°fico de barras (par√°metros: category, metric)
- `GET /api/chart/line` - Gr√°fico de l√≠neas (par√°metros: ticker, period)
- **Nota**: Todos los gr√°ficos se generan en backend, no se usa Chart.js

### Calendario de Earnings
- `GET /api/calendar` - Pr√≥ximos eventos de earnings
  - Agrega tickers de TRACKING_ASSETS, PORTFOLIO_ASSETS y watchlists
  - Filtra criptomonedas (no tienen earnings)
  - Retorna: ticker, name, date, eps_estimate, revenue_estimate
  - Solo eventos futuros/actuales

### Noticias
- `GET /api/news` - Noticias financieras (query: category)

### Reglas de Alertas
- `GET /api/rules` - Lista todas las reglas
- `POST /api/rules` - Crea nueva regla
- `PUT /api/rules/{rule_id}` - Actualiza una regla
- `DELETE /api/rules/{rule_id}` - Elimina una regla
- `POST /api/rules/chat` - Crea regla mediante IA (body: message, email)

### Sistema de Alertas
- `GET /api/alerts` - Retorna todas las alertas generadas
  - Incluye: id, rule_id, rule_name, ticker, message, timestamp, read, type

### Utilidades
- `GET /api/cache-info` - Informaci√≥n del estado del cach√©

### Servir Archivos Est√°ticos
- `GET /` - index.html
- `GET /dashboard.html` - Dashboard
- `GET /news.html` - Noticias
- `GET /rules.html` - Reglas
- `GET /pricing.html` - Pricing

## üîÑ Flujo de Datos

### Carga de Activos
1. Frontend solicita datos (`/api/{category}-assets`)
2. Backend verifica cach√© (TTLCache, 2 min TTL)
3. Si no en cach√©, consulta yfinance
4. Procesa datos (m√©tricas fundamentales, t√©cnicas, RSI, MACD, etc.)
5. Retorna JSON con AssetData
6. Frontend renderiza tabla con `renderTable()`

### Sistema de Cach√©
- **TTLCache**: 200 elementos m√°ximo, 120 segundos TTL
- **Clave de cach√©**: `{ticker}_{cache_window}` donde cache_window = timestamp // 120
- **Ventaja**: Reduce llamadas a yfinance, mejora rendimiento

### Sistema de Ejecuci√≥n de Reglas (Background Task)
1. **Inicio**: `startup_event()` inicia `check_rules_loop()` al arrancar servidor
2. **Loop Continuo**: Ejecuta cada 60 segundos
3. **Proceso**:
   - Carga todas las reglas activas desde `rules.json`
   - Obtiene tickers √∫nicos de todas las reglas
   - Fetchea datos actuales del mercado para cada ticker
   - Eval√∫a cada regla contra datos actuales
   - Genera alerta si condici√≥n se cumple
   - Verifica cooldown de 24 horas por regla
   - Guarda alerta en `alerts.json`
   - Actualiza `last_triggered` en regla
4. **Tipos de Reglas Soportadas**:
   - `price_above`: Precio > valor
   - `price_below`: Precio < valor
   - `pe_above`: P/E ratio > valor
   - `pe_below`: P/E ratio < valor
   - `max_distance`: Distancia desde m√°ximo > porcentaje
5. **Cooldown**: Previene spam, solo una alerta por regla cada 24 horas

### Generaci√≥n de Gr√°ficos
1. Frontend solicita imagen (`/api/chart/{type}`)
2. Backend genera gr√°fico con matplotlib/seaborn
3. Convierte a PNG en memoria (BytesIO)
4. Retorna como Response con `media_type="image/png"`
5. Frontend muestra imagen con `<img src="...">`
6. **Cache busting**: Timestamp en URL para evitar cach√© del navegador

### Calendario de Earnings
1. Frontend solicita `/api/calendar`
2. Backend agrega tickers de todas las categor√≠as
3. Filtra criptomonedas (no tienen earnings)
4. Usa `yf.Tickers()` para batch fetching
5. Extrae `earningsDate`, `earningsEstimate`, `revenueEstimate`
6. Filtra solo fechas futuras/actuales
7. Retorna JSON con eventos
8. Frontend formatea y muestra en tabla

### Configuraci√≥n de Tablas
1. Usuario abre modal de configuraci√≥n (bot√≥n ruedita)
2. `table-config.js` carga config desde localStorage
3. Usuario modifica: columnas visibles, orden, filtros
4. Al aplicar, se guarda en localStorage
5. `applyTableConfiguration()` aplica cambios a la tabla actual

### Sistema de Reglas
1. Usuario crea regla (manual o por IA)
2. Se guarda en `rules.json`
3. Backend valida regla (tipo, ticker, valor, email)
4. Frontend muestra regla en `rules.html`
5. **Background task** monitorea regla cada 60 segundos
6. Cuando se cumple, genera alerta en `alerts.json`

### Agentes de IA

**Agente de Reglas (`/api/rules/chat`):**
- Recibe mensaje en lenguaje natural
- Usa Groq API (Llama 3.1 8B) con prompt de sistema
- Extrae: name, type, ticker, value, email
- Valida y crea regla en `rules.json`
- Retorna confirmaci√≥n

**BullAgent (Investment Chat):**
- Webhook n8n: `https://dev.n8n.tomascabrera.site/webhook/.../chat`
- Payload: `{chatInput: string, sessionId: string}`
- SessionId persistido en sessionStorage
- Respuesta parseada de Markdown/HTML a HTML renderizado

## üìä Modelos de Datos

### AssetData (Pydantic)
```python
{
    name: str,
    ticker: str,
    price: float,
    pe_ratio: Optional[float],
    all_time_high: float,
    diff_from_max: float,
    # T√©cnicas
    volume, market_cap, cash_flow, dividend_yield,
    year_low, year_high, avg_volume,
    rsi, macd, sma_50, sma_200,
    # Fundamentales
    revenue, revenue_growth, profit_margin,
    roe, debt_to_equity, price_to_book, beta,
    # Logo
    logo_url: Optional[str]
}
```

### Rule (JSON)
```json
{
    "id": int,
    "name": str,
    "type": "price_below" | "price_above" | "pe_below" | "pe_above" | "max_distance",
    "ticker": str,
    "value": float,
    "email": str,
    "created_at": ISO datetime,
    "last_triggered": ISO datetime | null
}
```

### Alert (JSON)
```json
{
    "id": int,
    "rule_id": int,
    "rule_name": str,
    "ticker": str,
    "message": str,
    "timestamp": ISO datetime,
    "read": bool,
    "type": "price_above" | "price_below" | "pe_above" | "pe_below" | "max_distance"
}
```

### Calendar Event (JSON)
```json
{
    "ticker": str,
    "name": str,
    "date": "YYYY-MM-DD",
    "eps_estimate": float | null,
    "revenue_estimate": float | null
}
```

### Watchlist (JSON)
```json
{
    "watchlist_name": {
        "assets": ["TICKER1", "TICKER2", ...]
    }
}
```

## üé® Frontend - Componentes Principales

### Dashboard (`dashboard.js`)
- **`preloadAllData()`**: Precarga todas las categor√≠as en paralelo
- **`loadAssets(category, silent)`**: Carga datos con cach√© inteligente
- **`renderTable()`**: Renderiza tabla con datos
- **`createTableRow()`**: Crea fila de tabla con todas las m√©tricas
- **`setupSorting()`**: Configura sorting en headers
- **`loadCustomWatchlists()`**: Carga y renderiza watchlists personalizadas

### An√°lisis (`analisis.js`)
- **`loadAnalysisData()`**: Carga datos para gr√°ficos
- **`updateTreemapChart()`**: Carga imagen PNG desde `/api/chart/treemap` (NO Chart.js)
- **`updateBarChart()`**: Carga imagen PNG desde `/api/chart/bar` (NO Chart.js)
- **`loadLineChart()`**: Carga gr√°fico de l√≠neas hist√≥rico
- **Cache busting**: Agrega `&t=${Date.now()}` a URLs de im√°genes

### Calendario (`calendar.js`)
- **`loadCalendarData()`**: Fetchea datos de `/api/calendar`
- **`formatLargeNumber()`**: Formatea n√∫meros grandes (B/M/K)
- **Tab activation listener**: Carga datos al hacer click en tab
- **Error handling**: Mensajes amigables para errores

### Configuraci√≥n de Tablas (`table-config.js`)
- **`COLUMN_DEFINITIONS`**: Definiciones de columnas por categor√≠a
- **`getTableConfig()`**: Obtiene/crea configuraci√≥n desde localStorage
- **`applyTableConfiguration()`**: Aplica visibilidad, orden y filtros
- **`applyFilters()`**: Filtra filas seg√∫n condiciones

### Chat de Inversiones (`investment-chat.js`)
- **`sendInvestmentChatMessage()`**: Env√≠a mensaje a webhook n8n
- **`parseMarkdownToHtml()`**: Convierte markdown a HTML
- **`cleanAndStyleHtml()`**: Limpia y estiliza HTML recibido
- **`getSessionId()`**: Genera/mantiene sessionId en sessionStorage

## üîê Variables de Entorno

```bash
GROQ_API_KEY=tu_api_key_aqui  # Para agente de reglas
```

## üöÄ Configuraci√≥n y Ejecuci√≥n

### Instalaci√≥n
```bash
pip install -r requirements.txt
```

### Ejecuci√≥n
```bash
uvicorn app:app --reload --port 8080
```

### Acceso
- Frontend: `http://localhost:8080`
- API Docs: `http://localhost:8080/docs` (Swagger UI)

## üîß Configuraciones Importantes

### CORS
- Actualmente permite todos los or√≠genes (`*`)
- **Producci√≥n**: Restringir a dominios espec√≠ficos

### Cach√©
- TTL: 120 segundos (2 minutos)
- Tama√±o m√°ximo: 200 elementos
- Estrategia: Por ventana de tiempo (timestamp // 120)

### Background Tasks
- **Intervalo de verificaci√≥n**: 60 segundos
- **Cooldown de alertas**: 24 horas por regla
- **Inicio autom√°tico**: Al arrancar servidor via `startup_event()`

### Archivos Est√°ticos
- FastAPI sirve archivos est√°ticos desde el directorio ra√≠z
- Rutas: `/`, `/dashboard.html`, `/news.html`, etc.

## üìù Notas de Desarrollo

### Logos de Activos
- Se obtienen de `info.logo_url` (yfinance) o se construyen con Clearbit
- Fallback: `https://logo.clearbit.com/{domain}.com`

### Responsive Design
- Tailwind CSS con breakpoints est√°ndar
- Chat widgets adaptativos (full-screen en mobile)
- Tablas con scroll horizontal en mobile

### Modo Oscuro
- Implementado con Tailwind `dark:` classes
- Toggle persistido en localStorage
- `dark-mode.js` maneja el toggle

### B√∫squeda de Activos
- Endpoint `/api/search-assets` usa yfinance para buscar
- Debounce de 2 segundos en frontend
- Resultados mostrados en dropdown

### Gr√°ficos
- **NO se usa Chart.js** - Todos los gr√°ficos se generan en backend
- Im√°genes PNG retornadas directamente
- Cache busting con timestamp para evitar cach√© del navegador

## üêõ Issues Conocidos / Pendientes

1. **Email Notifications**: Las alertas se generan pero no se env√≠an por email (pendiente integraci√≥n SendGrid/AWS SES)
2. **Gesti√≥n de Alertas**: No hay UI para marcar alertas como le√≠das o eliminarlas
3. **Filtros de Calendario**: No hay capacidad de filtrar por activos espec√≠ficos o rangos de fechas
4. **Notificaciones del Navegador**: No hay alertas sonoras o notificaciones del sistema
5. **M√©tricas de Rendimiento**: No hay estad√≠sticas de frecuencia y precisi√≥n de reglas
6. **Account Panel**: Estructura creada pero funcionalidad limitada

## üîÑ Mejoras Futuras Sugeridas

1. **Base de Datos**: Migrar de JSON a SQLite/PostgreSQL
2. **Autenticaci√≥n**: Sistema de usuarios y sesiones
3. **WebSockets**: Actualizaciones en tiempo real
4. **Email Service**: Integraci√≥n con SendGrid o AWS SES
5. **Alert Management UI**: Marcar como le√≠das, eliminar, filtrar alertas
6. **Calendar Filters**: Filtrado por activos y rangos de fechas
7. **Browser Notifications**: Notificaciones del sistema operativo
8. **Rule Analytics**: Dashboard de m√©tricas de rendimiento de reglas
9. **Testing**: Unit tests y integration tests
10. **Docker**: Containerizaci√≥n para deployment
11. **CI/CD**: Pipeline de deployment automatizado

## ‚úÖ Funcionalidades Implementadas Recientemente

### Sistema de Ejecuci√≥n de Reglas (Nov 2025)
- Background task que verifica reglas cada 60 segundos
- Generaci√≥n autom√°tica de alertas cuando se cumplen condiciones
- Cooldown de 24 horas para prevenir spam
- Almacenamiento persistente en `alerts.json`
- Endpoint `/api/alerts` para consultar historial

### Calendario de Earnings (Nov 2025)
- Nueva tab "Calendario" en dashboard
- Endpoint `/api/calendar` que agrega tickers de todas las categor√≠as
- Filtrado autom√°tico de criptomonedas
- Visualizaci√≥n de pr√≥ximos eventos con estimaciones de EPS y revenue
- Formateo de fechas en espa√±ol y n√∫meros grandes (B/M/K)

### Correcci√≥n de Gr√°ficos (Nov 2025)
- Eliminado Chart.js del frontend
- Todos los gr√°ficos ahora se generan exclusivamente en backend
- Treemap y bar charts usan im√°genes PNG del servidor
- Cache busting implementado para evitar problemas de cach√©

---

**√öltima actualizaci√≥n**: Noviembre 2025


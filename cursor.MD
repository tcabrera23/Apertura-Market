# BullAnalytics - DocumentaciÃ³n TÃ©cnica y Arquitectura

## ğŸ—ï¸ Arquitectura del Proyecto

### Stack TecnolÃ³gico

**Backend:**
- **FastAPI** (Python): Framework web asÃ­ncrono para la API REST
- **yfinance**: Biblioteca para obtener datos financieros de Yahoo Finance
- **Groq API**: IntegraciÃ³n con modelo LLM (Llama 3.1 8B) para agentes de IA
- **matplotlib/seaborn**: GeneraciÃ³n de grÃ¡ficos en el backend
- **cachetools**: Sistema de cachÃ© con TTL (2 minutos) para optimizar rendimiento
- **Pillow**: Procesamiento de imÃ¡genes para grÃ¡ficos

**Frontend:**
- **HTML5/CSS3**: Estructura y estilos
- **Tailwind CSS**: Framework de utilidades CSS (modo oscuro con `class`)
- **JavaScript Vanilla**: Sin frameworks, cÃ³digo modular en archivos separados
- **Chart.js**: LibrerÃ­a para grÃ¡ficos interactivos (actualmente solo importada, no usada - grÃ¡ficos se generan en backend)

**Almacenamiento:**
- **JSON Files**: Persistencia local para:
  - `rules.json`: Reglas de alertas configuradas
  - `watchlists.json`: Listas de seguimiento personalizadas
- **localStorage**: Configuraciones de usuario (vistas de tablas, preferencias)

## ğŸ“ Estructura de Archivos

```
finance_portfolio/
â”œâ”€â”€ app.py                    # Backend FastAPI - API principal
â”œâ”€â”€ requirements.txt          # Dependencias Python
â”œâ”€â”€ rules.json               # Base de datos de reglas de alertas
â”œâ”€â”€ watchlists.json          # Base de datos de watchlists personalizadas
â”‚
â”œâ”€â”€ index.html               # Landing page
â”œâ”€â”€ dashboard.html           # Dashboard principal de activos
â”œâ”€â”€ news.html                # PÃ¡gina de noticias financieras
â”œâ”€â”€ rules.html               # GestiÃ³n de reglas de alertas
â”œâ”€â”€ account.html             # Panel de cuenta/usuario
â”œâ”€â”€ pricing.html             # PÃ¡gina de planes (integrada en index)
â”‚
â”œâ”€â”€ js/
â”‚   â”œâ”€â”€ dashboard.js         # LÃ³gica principal del dashboard
â”‚   â”œâ”€â”€ analisis.js          # GrÃ¡ficos y anÃ¡lisis visual
â”‚   â”œâ”€â”€ table-config.js      # ConfiguraciÃ³n de vistas de tablas
â”‚   â”œâ”€â”€ investment-chat.js   # Chat widget de inversiones (n8n)
â”‚   â”œâ”€â”€ rules.js             # GestiÃ³n de reglas
â”‚   â”œâ”€â”€ news.js              # Carga y renderizado de noticias
â”‚   â”œâ”€â”€ dark-mode.js         # Toggle de modo oscuro
â”‚   â””â”€â”€ main.js              # Scripts generales
â”‚
â”œâ”€â”€ css/
â”‚   â”œâ”€â”€ style.css            # Estilos globales
â”‚   â”œâ”€â”€ dashboard.css        # Estilos especÃ­ficos del dashboard
â”‚   â”œâ”€â”€ news.css             # Estilos de noticias
â”‚   â”œâ”€â”€ rules.css            # Estilos de reglas
â”‚   â””â”€â”€ pricing.css          # Estilos de pricing
â”‚
â”œâ”€â”€ images/
â”‚   â””â”€â”€ logo.png             # Logo de BullAnalytics
â”‚
â””â”€â”€ assets/
    â””â”€â”€ mockup.jpg           # Assets de diseÃ±o
```

## ğŸ”Œ API Endpoints (FastAPI)

### Assets y Datos Financieros
- `GET /api/tracking-assets` - Activos de seguimiento popular
- `GET /api/portfolio-assets` - Activos del portafolio personal
- `GET /api/crypto-assets` - Criptomonedas
- `GET /api/argentina-assets` - Acciones argentinas
- `GET /api/asset/{ticker}` - Datos de un activo especÃ­fico
- `GET /api/asset/{ticker}/history` - Historial de precios (parÃ¡metros: period, interval)
- `GET /api/search-assets` - BÃºsqueda de activos (query parameter)

### Watchlists Personalizadas
- `GET /api/watchlists` - Lista todas las watchlists
- `GET /api/watchlist/{name}` - Obtiene activos de una watchlist
- `POST /api/watchlist` - Crea nueva watchlist (body: name, assets[])
- `DELETE /api/watchlist/{name}` - Elimina una watchlist

### GrÃ¡ficos (Retornan imÃ¡genes PNG)
- `GET /api/chart/treemap` - Treemap (parÃ¡metros: category, metric)
- `GET /api/chart/bar` - GrÃ¡fico de barras (parÃ¡metros: category, metric)
- `GET /api/chart/line` - GrÃ¡fico de lÃ­neas (parÃ¡metros: ticker, period)

### Noticias
- `GET /api/news` - Noticias financieras (query: category)

### Reglas de Alertas
- `GET /api/rules` - Lista todas las reglas
- `POST /api/rules` - Crea nueva regla
- `PUT /api/rules/{rule_id}` - Actualiza una regla
- `DELETE /api/rules/{rule_id}` - Elimina una regla
- `POST /api/rules/chat` - Crea regla mediante IA (body: message, email)

### Utilidades
- `GET /api/cache-info` - InformaciÃ³n del estado del cachÃ©

### Servir Archivos EstÃ¡ticos
- `GET /` - index.html
- `GET /dashboard.html` - Dashboard
- `GET /news.html` - Noticias
- `GET /rules.html` - Reglas
- `GET /pricing.html` - Pricing

## ğŸ”„ Flujo de Datos

### Carga de Activos
1. Frontend solicita datos (`/api/{category}-assets`)
2. Backend verifica cachÃ© (TTLCache, 2 min TTL)
3. Si no en cachÃ©, consulta yfinance
4. Procesa datos (mÃ©tricas fundamentales, tÃ©cnicas, RSI, MACD, etc.)
5. Retorna JSON con AssetData
6. Frontend renderiza tabla con `renderTable()`

### Sistema de CachÃ©
- **TTLCache**: 200 elementos mÃ¡ximo, 120 segundos TTL
- **Clave de cachÃ©**: `{ticker}_{cache_window}` donde cache_window = timestamp // 120
- **Ventaja**: Reduce llamadas a yfinance, mejora rendimiento

### ConfiguraciÃ³n de Tablas
1. Usuario abre modal de configuraciÃ³n (botÃ³n ruedita)
2. `table-config.js` carga config desde localStorage
3. Usuario modifica: columnas visibles, orden, filtros
4. Al aplicar, se guarda en localStorage
5. `applyTableConfiguration()` aplica cambios a la tabla actual

### Sistema de Reglas
1. Usuario crea regla (manual o por IA)
2. Se guarda en `rules.json`
3. Backend valida regla (tipo, ticker, valor, email)
4. Frontend muestra regla en `rules.html`
5. **Nota**: Sistema de ejecuciÃ³n de reglas no implementado aÃºn (pendiente)

### Agentes de IA

**Agente de Reglas (`/api/rules/chat`):**
- Recibe mensaje en lenguaje natural
- Usa Groq API (Llama 3.1 8B) con prompt de sistema
- Extrae: name, type, ticker, value, email
- Valida y crea regla en `rules.json`
- Retorna confirmaciÃ³n

**BullAgent (Investment Chat):**
- Webhook n8n: `https://dev.n8n.tomascabrera.site/webhook/.../chat`
- Payload: `{chatInput: string, sessionId: string}`
- SessionId persistido en sessionStorage
- Respuesta parseada de Markdown/HTML a HTML renderizado

## ğŸ“Š Modelos de Datos

### AssetData (Pydantic)
```python
{
    name: str,
    ticker: str,
    price: float,
    pe_ratio: Optional[float],
    all_time_high: float,
    diff_from_max: float,
    # TÃ©cnicas
    volume, market_cap, cash_flow, dividend_yield,
    year_low, year_high, avg_volume,
    rsi, macd, sma_50, sma_200,
    # Fundamentales
    revenue, revenue_growth, profit_margin,
    roe, debt_to_equity, price_to_book, beta,
    # Logo
    logo_url: Optional[str]
}
```

### Rule (JSON)
```json
{
    "id": int,
    "name": str,
    "type": "price_below" | "price_above" | "pe_below" | "pe_above" | "max_distance",
    "ticker": str,
    "value": float,
    "email": str,
    "created_at": ISO datetime
}
```

### Watchlist (JSON)
```json
{
    "watchlist_name": {
        "assets": ["TICKER1", "TICKER2", ...]
    }
}
```

## ğŸ¨ Frontend - Componentes Principales

### Dashboard (`dashboard.js`)
- **`preloadAllData()`**: Precarga todas las categorÃ­as en paralelo
- **`loadAssets(category, silent)`**: Carga datos con cachÃ© inteligente
- **`renderTable()`**: Renderiza tabla con datos
- **`createTableRow()`**: Crea fila de tabla con todas las mÃ©tricas
- **`setupSorting()`**: Configura sorting en headers
- **`loadCustomWatchlists()`**: Carga y renderiza watchlists personalizadas

### AnÃ¡lisis (`analisis.js`)
- **`loadAnalysisData()`**: Carga datos para grÃ¡ficos
- **`updateTreemapChart()`**: Actualiza treemap desde imagen backend
- **`updateBarChart()`**: Actualiza grÃ¡fico de barras
- **`loadLineChart()`**: Carga grÃ¡fico de lÃ­neas histÃ³rico

### ConfiguraciÃ³n de Tablas (`table-config.js`)
- **`COLUMN_DEFINITIONS`**: Definiciones de columnas por categorÃ­a
- **`getTableConfig()`**: Obtiene/crea configuraciÃ³n desde localStorage
- **`applyTableConfiguration()`**: Aplica visibilidad, orden y filtros
- **`applyFilters()`**: Filtra filas segÃºn condiciones

### Chat de Inversiones (`investment-chat.js`)
- **`sendInvestmentChatMessage()`**: EnvÃ­a mensaje a webhook n8n
- **`parseMarkdownToHtml()`**: Convierte markdown a HTML
- **`cleanAndStyleHtml()`**: Limpia y estiliza HTML recibido
- **`getSessionId()`**: Genera/mantiene sessionId en sessionStorage

## ğŸ” Variables de Entorno

```bash
GROQ_API_KEY=tu_api_key_aqui  # Para agente de reglas
```

## ğŸš€ ConfiguraciÃ³n y EjecuciÃ³n

### InstalaciÃ³n
```bash
pip install -r requirements.txt
```

### EjecuciÃ³n
```bash
uvicorn app:app --reload --port 8080
```

### Acceso
- Frontend: `http://localhost:8080`
- API Docs: `http://localhost:8080/docs` (Swagger UI)

## ğŸ”§ Configuraciones Importantes

### CORS
- Actualmente permite todos los orÃ­genes (`*`)
- **ProducciÃ³n**: Restringir a dominios especÃ­ficos

### CachÃ©
- TTL: 120 segundos (2 minutos)
- TamaÃ±o mÃ¡ximo: 200 elementos
- Estrategia: Por ventana de tiempo (timestamp // 120)

### Archivos EstÃ¡ticos
- FastAPI sirve archivos estÃ¡ticos desde el directorio raÃ­z
- Rutas: `/`, `/dashboard.html`, `/news.html`, etc.

## ğŸ“ Notas de Desarrollo

### Logos de Activos
- Se obtienen de `info.logo_url` (yfinance) o se construyen con Clearbit
- Fallback: `https://logo.clearbit.com/{domain}.com`

### Responsive Design
- Tailwind CSS con breakpoints estÃ¡ndar
- Chat widgets adaptativos (full-screen en mobile)
- Tablas con scroll horizontal en mobile

### Modo Oscuro
- Implementado con Tailwind `dark:` classes
- Toggle persistido en localStorage
- `dark-mode.js` maneja el toggle

### BÃºsqueda de Activos
- Endpoint `/api/search-assets` usa yfinance para buscar
- Debounce de 2 segundos en frontend
- Resultados mostrados en dropdown

## ğŸ› Issues Conocidos / Pendientes

1. **Sistema de EjecuciÃ³n de Reglas**: Las reglas se crean pero no se ejecutan automÃ¡ticamente (decidir si enviar los correos mediante smtp, n8n o mediante un scheduler externo)
2. **Calendario de Resultados**: Agregar una tab de calendario de resultados en el dashboard.html
3. **Chart.js**: Importado pero no usado (grÃ¡ficos se generan en backend) y no se muestran el el front (algun tipo de conflicto con la tab que se lee desde watchlist.json)
4. **Configurar vistas**: El boton esta visual en el front de dashboard.html pero no permite configurar las vistas (ocultar columnas de las tablas, cambiar el orden, filtrar)
5. **Agregar imagenes**: Cada activo debe tener su logo en la columna de assets
6. **Dark mode**: Oscurecerlo como en la imagen adjunta 
7. **Interfaz de chat de los agentes**: Debe seguir los colores principales de nuestra web (verde) y blanco o negro segun mode

## ğŸ”„ Mejoras Futuras Sugeridas

1. **Base de Datos**: Migrar de JSON a SQLite/PostgreSQL
2. **AutenticaciÃ³n**: Sistema de usuarios y sesiones
3. **WebSockets**: Actualizaciones en tiempo real
4. **Testing**: Unit tests y integration tests
5. **Docker**: ContainerizaciÃ³n para deployment
6. **CI/CD**: Pipeline de deployment automatizado

---

**Ãšltima actualizaciÃ³n**: Noviembre 2025

